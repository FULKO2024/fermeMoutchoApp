workflows:
  android-workflow:
    name: Android Build
    environment:
      vars:
        PACKAGE_NAME: "com.fermemoutcho.app"
      android_signing:
        - keystore_reference
      groups:
        - google_play
    scripts:
      - name: Set up environment
        script: |
          #!/usr/bin/env sh
          set -e
          echo "Setting up environment..."
          
      - name: Install dependencies
        script: |
          #!/usr/bin/env sh
          set -e
          npm ci
          
      - name: Add Android platform
        script: |
          #!/usr/bin/env sh
          set -e
          npx cap add android
          
      - name: Sync project
        script: |
          #!/usr/bin/env sh
          set -e
          npx cap sync android
          
      - name: Build Android App Bundle
        script: |
          #!/usr/bin/env sh
          set -e
          cd android
          ./gradlew bundleRelease
          
    artifacts:
      - build/**/outputs/**/*.aab
      - build/**/outputs/**/*.apk
      - android/app/build/outputs/**/mapping.txt
      - /tmp/xcodebuild_logs/*.log
      - flutter_drive.log
    publishing:
      google_play:
        credentials: $GOOGLE_PLAY_CREDENTIALS
        track: internal

  ios-workflow:
    name: iOS Build
    environment:
      vars:
        XCODE_PROJECT: "ios/App/App.xcodeproj"
        XCODE_SCHEME: "App"
        BUNDLE_ID: "com.fermemoutcho.app"
      xcode: latest
      cocoapods: default
      groups:
        - ios_signing
    scripts:
      - name: Set up environment
        script: |
          #!/usr/bin/env sh
          set -e
          echo "Setting up iOS environment..."
          echo "Xcode version: $(xcodebuild -version)"
          echo "Current directory: $(pwd)"
          echo "Development Team: $DEVELOPMENT_TEAM"
          
      - name: Install dependencies
        script: |
          #!/usr/bin/env sh
          set -e
          npm ci
          
      - name: Add iOS platform
        script: |
          #!/usr/bin/env sh
          set -e
          npx cap add ios
          
      - name: Sync project
        script: |
          #!/usr/bin/env sh
          set -e
          npx cap sync ios
          
      - name: Install CocoaPods
        script: |
          #!/usr/bin/env sh
          set -e
          cd ios/App
          pod install --repo-update
          
      - name: Configure iOS signing for automatic mode
        script: |
          #!/usr/bin/env sh
          set -e
          echo "Configuring iOS signing for automatic mode..."
          
          # V√©rifier que le Team ID est d√©fini
          if [ -z "$DEVELOPMENT_TEAM" ]; then
            echo "‚ùå Error: DEVELOPMENT_TEAM variable is not set!"
            echo "Please configure the ios_signing variable group in CodeMagic"
            exit 1
          fi
          
          echo "Using Development Team: $DEVELOPMENT_TEAM"
          
          # Cr√©er le fichier exportOptions.plist pour signing automatique
          cat > exportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>development</string>
              <key>signingStyle</key>
              <string>automatic</string>
              <key>teamID</key>
              <string>$DEVELOPMENT_TEAM</string>
              <key>stripSwiftSymbols</key>
              <true/>
              <key>uploadBitcode</key>
              <false/>
              <key>uploadSymbols</key>
              <true/>
              <key>compileBitcode</key>
              <false/>
          </dict>
          </plist>
          EOF
          
          echo "exportOptions.plist created with team ID: $DEVELOPMENT_TEAM"
          cat exportOptions.plist
          
      - name: List iOS project structure
        script: |
          #!/usr/bin/env sh
          set -e
          echo "iOS project structure:"
          ls -la ios/App/
          echo "Xcode project files:"
          ls -la ios/App/*.xcodeproj/
          
      - name: Build iOS Archive with automatic signing
        script: |
          #!/usr/bin/env sh
          set -e
          echo "Starting iOS archive build with automatic signing..."
          
          # V√©rifier que le projet existe
          if [ ! -d "ios/App/App.xcworkspace" ]; then
            echo "Error: App.xcworkspace not found!"
            ls -la ios/App/
            exit 1
          fi
          
          # Build avec signing automatique complet
          xcodebuild -workspace ios/App/App.xcworkspace \
                     -scheme App \
                     -configuration Release \
                     -destination generic/platform=iOS \
                     -archivePath /tmp/App.xcarchive \
                     archive \
                     -verbose \
                     -allowProvisioningUpdates \
                     -allowProvisioningDeviceRegistration \
                     CODE_SIGN_STYLE=Automatic \
                     CODE_SIGN_IDENTITY="" \
                     DEVELOPMENT_TEAM="$DEVELOPMENT_TEAM" \
                     PROVISIONING_PROFILE=""
          
          echo "‚úÖ iOS Archive created successfully with automatic signing!"
          echo "üì¶ Archive location: /tmp/App.xcarchive"
          
      - name: Attempt IPA export (optional)
        script: |
          #!/usr/bin/env sh
          set -e
          echo "Attempting to export iOS IPA (this may fail without proper Apple account integration)..."
          
          # Essayer d'exporter l'IPA (peut √©chouer)
          if xcodebuild -exportArchive \
                        -archivePath /tmp/App.xcarchive \
                        -exportPath /tmp/App \
                        -exportOptionsPlist exportOptions.plist \
                        -verbose \
                        -allowProvisioningUpdates; then
            echo "üéâ IPA exported successfully!"
            echo "IPA location: /tmp/App/App.ipa"
          else
            echo "‚ö†Ô∏è IPA export failed (expected without Apple account integration)"
            echo "üì¶ But your archive is ready for manual export!"
            echo ""
            echo "üí° To get your IPA:"
            echo "1. Download the .xcarchive file from this build"
            echo "2. Open it in Xcode on a Mac"
            echo "3. Go to Window ‚Üí Organizer"
            echo "4. Select your archive and click 'Distribute App'"
            echo "5. Choose 'Development' and follow the steps"
            echo ""
            echo "üéØ Your iOS app is successfully built and archived!"
          fi
          
    artifacts:
      - /tmp/App/App.ipa
      - /tmp/App.xcarchive
      - /tmp/xcodebuild_logs/*.log 